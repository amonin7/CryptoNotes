# Как работает Rebase токен на уровне алгоритма?
Идея состоит в том, что вместо волатильности цен изменяется предложение токенов посредством событий, называемых rebase'ами.\
Rebase токен работает таким образом, что циркулирующее предложение расширяется или сокращается из-за изменений в цене токена.\
В некотором смысле Rebase токены можно сравнить со стейблкоинами. Они нацелены на достижение целевой цены, и эта механика перебазирования способствует этому. Отличие заключается в том, что перебазированные токены нацелены на достижение этого с ИСКУССТВЕННО  изменяющимся предложением (система управвляет предложением).\
Допустим, у нас есть Rebase токен, у которого целевая стоимость - 1$.\
Глобально алгоритм: Если цена поднялась выше 1$, протокол увеличивает текущее предложение, уменьшая стоимость каждого токена. И наоборот, если цена ниже 1$, протокол уменьшит предложение, в результате чего каждый токен будет стоить больше.\
Уменьшение и увеличение предложения происходит за счет практического изменения количества токенов в кошельках у ВСЕХ пользователей. То есть допустим мы вчера купили 100 Rebase токенов по 1$ и заплатили 100$. Они лежат у нас в кошельке. Сегодня цена токенов выросла до 1.1$ за токен. Это значит что вырос спрос или уменьшилось предложение -> надо вернуть предложение обратно. После rebase операции у нас в кошельке будет 110 Rebase токенов в кошельке, но каждый из них будет стоить дешевле. Таким образом система искусственно увеличивает предложение, что соответственно уменьшает цену.\
 
# Какие проблемы возникают при размещении rebase токена типа aUSDC в AMM типа Uniswap V2
Кратко - так как количество rebase токенов в кошельке может легко поменяться (как раз в процессе ребейза), то очевидно, что возникает проблема того, что до сделки было одно количество токенов (часть надо было отправить, часть на fee, часть оставить на кошельке) - то во время сделки необходимо будет "разделять по частям" уже совершенно другое количество.
1. **Negative rebase ** 
Это случай, когда предложения на рынке много, цена падает и необходимо сокращать кол-во токенов в обращении. Соответственно уменьшается и кол-во токенов в вашем кошельке и кол-во токенов, которые могут быть потрачены в ходе транзакции. Так как ребейз алгоритм тригеррится (вызывается) не трансфером, роутер не знает ничего о том, как и когда произойдет ребейз. Соответственно как только происходит ребейз - зарезервированные для транзакции токены будут "разбалансированы" и стоимость "разницы" в результате процесса ребейза будет нести следующий человек, который совершит сделку с парой.
Сразу о решении этой проблемы. Проблема с токенами с "негативным ребейзом" была решена следующим образом: они просто поменяли контракт таким образом, что теперь перед завершением транзакции вызывается метод "синхронизации" (синхронизации остатков условно) торговой пары. Таким образом достигается корректное завершение транзакции.
2. **Positive rebase**
Это обратная ситуация, когда предложениия на рынке мало, цена увеличивается и необходимо кол-во токенов в обращении.Соответственно увеличиваается и кол-во токенов в кошельке. Когда происходит Positive rebase, создается профицит, который не учитывается в торговой паре. Поскольку дополнительные токены не учитываются в торговой паре, любой может вызвать skim() для торговой пары и фактически украсть положительную разницу от rebase'a. С одной стороны Positive rebase не нарушает никаких правил АММ, но с другой положительный баланс, найденный в любой паре, будет свободно доступен для использования другим лицам.

# Какие методы решения данных проблем концептуально и практически существуют
### Теоретически
- первый вариант, который я уже написал выше - это проверка, не случилось ли ребейза перед завершением транзакции. Если случилось - попросить пользователя еще раз выполнить транзакцию с обновленнымии данными например?
- второй вариант, который сразу выражается практически - это то, как сделано в новом проекте ElasticSwap. Он сделан ровно чтобы решать проблему работы с rebase токенами в АММ. ElasticSwap отменяет rebase процесс в любой паре, которая вышла из равновесия, и стимулирует следующего участника «исправить» дисбаланс, введя только сумму, необходимую для исправления дисбаланса, плюс любую дополнительную позицию LP, которую хочет участник.

### Пример: 
**При использовании ElasticSwap:**
Балансы пула перед rebase'ом:
10000 (0 "долг") AMPL / 10000 (0 "долг") USDC, 1 AMPL стоит 1.0001 USDC
Балансы пула после rebase'a:
10000 (1000 "долг") AMPL / 10000 (0 "долг") USDC, 1 AMPL стоит 1.0001 USDC
В этом случае, чтобы исправить дисбаланс, следующий участник пула может войти только с 2000 USDC и 1000 AMPL. (и плюс новая позиция, если надо)

**При использовании UniSwap/SushiSwap:**
Балансы пула перед rebase'ом:
10000 AMPL / 10000 USDC, 1 AMPL стоит 1,0001 USDC
Балансы пула после rebase'a:
11000 AMPL / 10000 USDC, 1 AMPL стоит ~0,90917356 USDC
